load.ec2.create_security_group:
  GroupName: ${LOAD_BALANCER_SECURITY_GROUP_NAME}
  Description: Sage security group
load.ec2.describe_security_groups:
  GroupNames:
    - ${LOAD_BALANCER_SECURITY_GROUP_NAME}
load.ec2.authorize_security_group_ingress:
  ToPort: ${LOAD_BALANCER_PORT}
  FromPort: ${LOAD_BALANCER_PORT}
  IpProtocol: ${LOAD_BALANCER_IP_PROTOCOL}
  CidrIp: ${LOAD_BALANCER_REACHABLE_CIDR_BLOCK}
  GroupName: ${LOAD_BALANCER_SECURITY_GROUP_NAME}
---
load.app.elb.create_load_balancer:
  Name: ${APP_LOAD_BALANCER_NAME}
  Subnets:
    - $(infra.ec2.describe_subnets.Subnets.0.SubnetId)
    - $(infra.ec2.describe_subnets.Subnets.1.SubnetId)
    - $(infra.ec2.describe_subnets.Subnets.2.SubnetId)
    - $(infra.ec2.describe_subnets.Subnets.3.SubnetId)
  SecurityGroups:
    - $(load.ec2.describe_security_groups.SecurityGroups.0.GroupId)
  Scheme: ${LOAD_BALANCER_SCHEME}
  Type: ${LOAD_BALANCER_TYPE}
load.app.elb_waiter.wait:
  Names:
    - ${APP_LOAD_BALANCER_NAME}
load.app.elb.describe_load_balancers:
  Names:
    - ${APP_LOAD_BALANCER_NAME}
load.app.ec2.create_security_group:
  GroupName: ${APP_SECURITY_GROUP_NAME}
  Description: Sage app security group
load.app.ec2.authorize_security_group_ingress:
  GroupName: ${APP_SECURITY_GROUP_NAME}
  ToPort: ${APP_CONTAINER_PORT}
  FromPort: ${APP_CONTAINER_PORT}
  SourceSecurityGroupName: ${LOAD_BALANCER_SECURITY_GROUP_NAME}
load.app.ec2.describe_security_groups:
  GroupNames:
    - ${APP_SECURITY_GROUP_NAME}
load.app.elb.create_target_group:
  Port: ${APP_CONTAINER_PORT}
  Name: ${APP_TARGET_GROUP_NAME}
  TargetType: ${APP_TARGET_GROUP_TYPE}
  Protocol: ${APP_TARGET_GROUP_PROTOCOL}
  ProtocolVersion: ${APP_TARGET_GROUP_PROTOCOL_VERSION}
  VpcId: $(infra.ec2.describe_vpcs.Vpcs.0.VpcId)
load.app.elb.create_listener:
  LoadBalancerArn: $(load.app.elb.describe_load_balancers.LoadBalancers.0.LoadBalancerArn)
  Protocol: ${LOAD_BALANCER_PROTOCOL}
  Port: ${LOAD_BALANCER_PORT}
  Certificates:
    - CertificateArn: $(certs.acm.describe_certificate.Certificate.CertificateArn)
  DefaultActions:
    - Type: forward
      TargetGroupArn: $(load.app.elb.create_target_group.TargetGroups.0.TargetGroupArn)
---
load.wss.elb.create_load_balancer:
  Name: ${WSS_LOAD_BALANCER_NAME}
  Subnets:
    - $(infra.ec2.describe_subnets.Subnets.0.SubnetId)
    - $(infra.ec2.describe_subnets.Subnets.1.SubnetId)
    - $(infra.ec2.describe_subnets.Subnets.2.SubnetId)
    - $(infra.ec2.describe_subnets.Subnets.3.SubnetId)
  SecurityGroups:
    - $(load.ec2.describe_security_groups.SecurityGroups.0.GroupId)
  Scheme: ${LOAD_BALANCER_SCHEME}
  Type: ${LOAD_BALANCER_TYPE}
load.wss.elb_waiter.wait:
  Names:
    - ${WSS_LOAD_BALANCER_NAME}
load.wss.elb.describe_load_balancers:
  Names:
    - ${WSS_LOAD_BALANCER_NAME}
load.wss.ec2.create_security_group:
  GroupName: ${WSS_SECURITY_GROUP_NAME}
  Description: Sage wss security group
load.wss.ec2.authorize_security_group_ingress:
  GroupName: ${WSS_SECURITY_GROUP_NAME}
  ToPort: ${WSS_CONTAINER_PORT}
  FromPort: ${WSS_CONTAINER_PORT}
  SourceSecurityGroupName: ${LOAD_BALANCER_SECURITY_GROUP_NAME}
load.wss.ec2.describe_security_groups:
  GroupNames:
    - ${WSS_SECURITY_GROUP_NAME}
load.wss.elb.create_target_group:
  Port: ${WSS_CONTAINER_PORT}
  Name: ${WSS_TARGET_GROUP_NAME}
  TargetType: ${WSS_TARGET_GROUP_TYPE}
  Protocol: ${WSS_TARGET_GROUP_PROTOCOL}
  ProtocolVersion: ${WSS_TARGET_GROUP_PROTOCOL_VERSION}
  VpcId: $(infra.ec2.describe_vpcs.Vpcs.0.VpcId)
load.wss.elb.create_listener:
  LoadBalancerArn: $(load.wss.elb.describe_load_balancers.LoadBalancers.0.LoadBalancerArn)
  Protocol: ${LOAD_BALANCER_PROTOCOL}
  Port: ${LOAD_BALANCER_PORT}
  Certificates:
    - CertificateArn: $(certs.acm.describe_certificate.Certificate.CertificateArn)
  DefaultActions:
    - Type: forward
      TargetGroupArn: $(load.wss.elb.create_target_group.TargetGroups.0.TargetGroupArn)
