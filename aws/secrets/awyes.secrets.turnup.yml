secrets.turnup.db.user.ssm.put_parameter:
  Name: DB_USERNAME
  Value: ${DB_USERNAME}
  Type: SecureString
  Overwrite: true
secrets.turnup.db.pass.ssm.put_parameter:
  Name: DB_PASSWORD
  Value: ${DB_PASSWORD}
  Type: SecureString
  Overwrite: true
---
secrets.turnup.apple.secrets.create_secret:
  Name: APPLE_CLIENT_SECRET
  Description: Apple Client Secret
---
secrets.turnup.apple.ecr.list_images:
  repositoryName: ${SECRETS_ECR_REPO_NAME}
---
secrets.turnup.apple.lmda.update_function_code:
  FunctionName: ${SECRETS_LAMBDA_NAME}
  ImageUri: ${SAGE_ACCOUNT_ID}.dkr.ecr.${SAGE_REGION}.amazonaws.com/${SECRETS_ECR_REPO_NAME}:$(images.turnup.gitrev)
  Architectures:
    - ${SECRETS_LAMBDA_ARCHITECTURE}
  Publish: true
---
secrets.turnup.apple.lmda.create_function:
  FunctionName: ${SECRETS_LAMBDA_NAME}
  Role: $(role.turnup.iam.get_role.Role.Arn)
  PackageType: Image
  Code:
    ImageUri: ${SAGE_ACCOUNT_ID}.dkr.ecr.${SAGE_REGION}.amazonaws.com/${SECRETS_ECR_REPO_NAME}:$(images.turnup.gitrev)
  Architectures:
    - ${SECRETS_LAMBDA_ARCHITECTURE}
  Timeout: ${SECRETS_LAMBDA_TIMEOUT}
  MemorySize: ${SECRETS_LAMBDA_MEMORY}
  Publish: true
secrets.turnup.apple.function_active.wait:
  FunctionName: ${SECRETS_LAMBDA_NAME}
secrets.turnup.apple.lmda.get_function:
  FunctionName: ${SECRETS_LAMBDA_NAME}
secrets.turnup.apple.lmda.add_permission:
  FunctionName: ${SECRETS_LAMBDA_NAME}
  StatementId: SecretsManagerAccess
  Principal: secretsmanager.amazonaws.com
  Action: lambda:InvokeFunction
secrets.turnup.apple.secrets.rotate_secret:
  SecretId: APPLE_CLIENT_SECRET
  RotationLambdaARN: $(secrets.turnup.apple.lmda.get_function.Configuration.FunctionArn)
  RotationRules:
    ScheduleExpression: rate(4 hour)
