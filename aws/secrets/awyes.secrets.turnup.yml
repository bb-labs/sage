secrets.turnup.db.user.ssm.put_parameter:
  Name: DB_USERNAME
  Value: ${DB_USERNAME}
  Type: SecureString
  Overwrite: true
secrets.turnup.db.pass.ssm.put_parameter:
  Name: DB_PASSWORD
  Value: ${DB_PASSWORD}
  Type: SecureString
  Overwrite: true
---
secrets.turnup.apple.secrets.create_secret:
  Name: APPLE_CLIENT_SECRET
  Description: Apple Client Secret
---
secrets.turnup.apple.image.build:
  tag: ${SAGE_ACCOUNT_ID}.dkr.ecr.${SAGE_REGION}.amazonaws.com/${SECRETS_ECR_REPO_NAME}:${SECRETS_LAMBDA_IMAGE_NAME}
  path: ${SECRETS_LAMBDA_PATH}
  platform: ${SECRETS_LAMBDA_IMAGE_PLATFORM}
  dockerfile: Dockerfile
secrets.turnup.apple.image.push:
  repository: ${SAGE_ACCOUNT_ID}.dkr.ecr.${SAGE_REGION}.amazonaws.com/${SECRETS_ECR_REPO_NAME}
  tag: ${SECRETS_LAMBDA_IMAGE_NAME}
  auth_config:
    username: AWS
    password: $(repos.auth.re.sub)
secrets.turnup.apple.ecr.list_images:
  repositoryName: ${SECRETS_ECR_REPO_NAME}
---
secrets.turnup.apple.lmda.create_function:
  FunctionName: ${SECRETS_LAMBDA_NAME}
  Role: $(role.turnup.iam.get_role.Role.Arn)
  PackageType: Image
  Environment:
    Variables:
      APPLE_TEAM_ID: ${APPLE_TEAM_ID}
      APPLE_BUNDLE_ID: ${APPLE_BUNDLE_ID}
      APPLE_KEY_ID: ${APPLE_KEY_ID}
      APPLE_KEY_PATH: ${APPLE_KEY_PATH}
      APPLE_KEY_DURATION: "${APPLE_KEY_DURATION}"
  Code:
    ImageUri: ${SAGE_ACCOUNT_ID}.dkr.ecr.${SAGE_REGION}.amazonaws.com/${SECRETS_ECR_REPO_NAME}@$(secrets.turnup.apple.ecr.list_images.imageIds.0.imageDigest)
  Architectures:
    - ${SECRETS_LAMBDA_ARCHITECTURE}
  Timeout: ${SECRETS_LAMBDA_TIMEOUT}
  MemorySize: ${SECRETS_LAMBDA_MEMORY}
  Publish: true
secrets.turnup.apple.function_active.wait:
  FunctionName: ${SECRETS_LAMBDA_NAME}
secrets.turnup.apple.lmda.get_function:
  FunctionName: ${SECRETS_LAMBDA_NAME}
secrets.turnup.apple.lmda.add_permission:
  FunctionName: ${SECRETS_LAMBDA_NAME}
  StatementId: SecretsManagerAccess
  Principal: secretsmanager.amazonaws.com
  Action: lambda:InvokeFunction
secrets.turnup.apple.secrets.rotate_secret:
  SecretId: APPLE_CLIENT_SECRET
  RotationLambdaARN: $(secrets.turnup.apple.lmda.get_function.Configuration.FunctionArn)
  RotationRules:
    ScheduleExpression: rate(4 hour)
