# # -------------------------------------------------------------------
# # user
# # -------------------------------------------------------------------
user:
  get_user:
    client: iam
    workflow:
      - init
  get_caller_identity:
    client: sts
    workflow:
      - init

# # -------------------------------------------------------------------
# # role
# # -------------------------------------------------------------------

role:
  get_role:
    client: iam
    depends_on:
      - role.create_role
    workflow:
      - init
    args:
      RoleName: sage
  create_role:
    client: iam
    workflow:
      - init
    args:
      RoleName: sage
      Description: Role for sage kubernetes cluster
      AssumeRolePolicyDocument: >
        {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": { 
              "Service": [
                "lambda.amazonaws.com", 
                "rds.amazonaws.com",
                "eks.amazonaws.com"
              ] 
            },
            "Action": "sts:AssumeRole"
          }]
        }
  attach_role_policy:
    client: iam
    workflow:
      - init
    depends_on:
      - role.get_role
    args:
      RoleName: sage
      PolicyArn: arn:aws:iam::aws:policy/AmazonEKSClusterPolicy

# # -------------------------------------------------------------------
# # kubernetes
# # -------------------------------------------------------------------

kube:
  update_auth:
    client: user
    depends_on:
      - user.get_caller_identity
    workflow:
      - init
    args:
      - $(user.get_caller_identity.Account)
  update_config:
    client: user
    workflow:
      - init
  describe_vpcs:
    client: ec2
    workflow:
      - init
  describe_security_groups:
    client: ec2
    workflow:
      - init
    args:
      GroupNames:
        - default
  describe_subnets:
    client: ec2
    workflow:
      - init
    depends_on:
      - vpcs.describe_vpcs
    args:
      Filters:
        - Name: vpc-id
          Values:
            - $(vpcs.describe_vpcs.Vpcs.0.VpcId)
  create_cluster:
    client: eks
    workflow:
      - init
    depends_on:
      - role.get_role
      - subnets.describe_subnets
      - security_groups.describe_security_groups
    args:
      name: sage
      version: 1.28
      roleArn: $(role.get_role.Role.Arn)
      resourcesVpcConfig:
        securityGroupIds:
          - $(security_groups.describe_security_groups.SecurityGroups.0.GroupId)
        subnetIds:
          - $(subnets.describe_subnets.Subnets.0.SubnetId)
          - $(subnets.describe_subnets.Subnets.1.SubnetId)
          - $(subnets.describe_subnets.Subnets.2.SubnetId)
          - $(subnets.describe_subnets.Subnets.3.SubnetId)
        endpointPublicAccess: true
