repo.user.get_latest_repo_revision:
---
apple.user.save_ios_protos:
  - sage.pb.swift
  - sage.grpc.swift
apple.user.apple_client_secret:
  team_id: ${APPLE_TEAM_ID}
  bundle_id: ${APPLE_BUNDLE_ID}
  key_id: ${APPLE_KEY_ID}
  key_path: certs/AuthKey_2AH2XL345Z.p8
apple.bundle_id.ssm.put_parameter:
  Name: APPLE_BUNDLE_ID
  Value: ${APPLE_BUNDLE_ID}
  Type: SecureString
  Overwrite: true
apple.client_secret.ssm.put_parameter:
  Name: APPLE_CLIENT_SECRET
  Value: $(apple.user.apple_client_secret)
  Type: SecureString
  Overwrite: true
---
env.db.user.ssm.put_parameter:
  Name: DB_USERNAME
  Value: ${DB_USERNAME}
  Type: SecureString
  Overwrite: true
env.db.pass.ssm.put_parameter:
  Name: DB_PASSWORD
  Value: ${DB_PASSWORD}
  Type: SecureString
  Overwrite: true
env.db.name.ssm.put_parameter:
  Name: DB_NAME
  Value: ${DB_NAME}
  Type: SecureString
  Overwrite: true
env.db.host.ssm.put_parameter:
  Name: DB_HOST
  Value: ${DB_DOMAIN}
  Type: SecureString
  Overwrite: true
env.db.port.ssm.put_parameter:
  Name: DB_PORT
  Value: "${DB_PORT}"
  Type: SecureString
  Overwrite: true
env.app.port.ssm.put_parameter:
  Name: APP_PORT
  Value: "${APP_PORT}"
  Type: SecureString
  Overwrite: true
env.wss.port.ssm.put_parameter:
  Name: WSS_PORT
  Value: "${WSS_PORT}"
  Type: SecureString
  Overwrite: true
---
sage.iam.create_role:
  RoleName: ${SAGE_ROLE_NAME}
  Description: Role for sage aws app
  AssumeRolePolicyDocument: >
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": { 
            "Service": [
              "ec2.amazonaws.com",
              "ecs.amazonaws.com",
              "ecs-tasks.amazonaws.com",
              "route53.amazonaws.com",
              "rds.amazonaws.com",
              "ssm.amazonaws.com"
            ]
          },
          "Action": "sts:AssumeRole"
        }
      ]
    }
sage.logs.iam.attach_role_policy:
  RoleName: ${SAGE_ROLE_NAME}
  PolicyArn: arn:aws:iam::aws:policy/CloudWatchFullAccessV2
sage.ssm.iam.attach_role_policy:
  RoleName: ${SAGE_ROLE_NAME}
  PolicyArn: arn:aws:iam::aws:policy/AmazonSSMFullAccess
sage.secrets.iam.attach_role_policy:
  RoleName: ${SAGE_ROLE_NAME}
  PolicyArn: arn:aws:iam::aws:policy/SecretsManagerReadWrite
sage.kms.iam.attach_role_policy:
  RoleName: ${SAGE_ROLE_NAME}
  PolicyArn: arn:aws:iam::aws:policy/service-role/ROSAKMSProviderPolicy
sage.rds.iam.attach_role_policy:
  RoleName: ${SAGE_ROLE_NAME}
  PolicyArn: arn:aws:iam::aws:policy/AmazonRDSFullAccess
sage.iam.get_role:
  RoleName: ${SAGE_ROLE_NAME}
sage.acm.request_certificate:
  DomainName: ${SAGE_DOMAIN}
  ValidationMethod: DNS
  SubjectAlternativeNames:
    - ${WSS_DOMAIN}
    - ${APP_DOMAIN}
sage.acm.describe_certificate:
  CertificateArn: $(sage.acm.request_certificate.CertificateArn)
sage.route53.list_hosted_zones_by_name:
  DNSName: ${SAGE_DOMAIN}
sage.route53.change_resource_record_sets:
  HostedZoneId: $(sage.route53.list_hosted_zones_by_name.HostedZones.0.Id)
  ChangeBatch:
    Changes:
      - Action: UPSERT
        ResourceRecordSet:
          Name: $(sage.acm.describe_certificate.Certificate.DomainValidationOptions.0.ResourceRecord.Name)
          Type: CNAME
          TTL: 300
          ResourceRecords:
            - Value: $(sage.acm.describe_certificate.Certificate.DomainValidationOptions.0.ResourceRecord.Value)
      - Action: UPSERT
        ResourceRecordSet:
          Name: $(sage.acm.describe_certificate.Certificate.DomainValidationOptions.1.ResourceRecord.Name)
          Type: CNAME
          TTL: 300
          ResourceRecords:
            - Value: $(sage.acm.describe_certificate.Certificate.DomainValidationOptions.1.ResourceRecord.Value)
      - Action: UPSERT
        ResourceRecordSet:
          Name: $(sage.acm.describe_certificate.Certificate.DomainValidationOptions.2.ResourceRecord.Name)
          Type: CNAME
          TTL: 300
          ResourceRecords:
            - Value: $(sage.acm.describe_certificate.Certificate.DomainValidationOptions.2.ResourceRecord.Value)
sage.ec2.describe_vpcs:
sage.ec2.describe_subnets:
  Filters:
    - Name: vpc-id
      Values:
        - $(sage.ec2.describe_vpcs.Vpcs.0.VpcId)
sage.ec2.create_security_group:
  GroupName: ${SAGE_SECURITY_GROUP_NAME}
  Description: Sage security group
sage.ec2.describe_security_groups:
  GroupNames:
    - ${SAGE_SECURITY_GROUP_NAME}
sage.ec2.authorize_security_group_ingress:
  GroupName: ${SAGE_SECURITY_GROUP_NAME}
  IpPermissions:
    - FromPort: 443
      ToPort: 443
      IpProtocol: TCP
      IpRanges:
        - CidrIp: "0.0.0.0/0"
---
cluster.ecs.create_cluster:
  clusterName: ${CLUSTER_NAME}
---
app.image.build:
  tag: ${DOCKER_REGISTRY}/${APP_NAME}:$(repo.user.get_latest_repo_revision)
  path: app
  dockerfile: Dockerfile
app.image.push:
  repository: ${DOCKER_REGISTRY}/${APP_NAME}
  tag: $(repo.user.get_latest_repo_revision)
  auth_config:
    username: ${DOCKER_HUB_USERNAME}
    password: ${DOCKER_HUB_PASSWORD}
app.elb.create_target_group:
  Name: ${APP_TARGET_GROUP_NAME}
  Protocol: ${LOAD_BALANCER_PROTOCOL}
  TargetType: ${APP_TARGET_GROUP_TYPE}
  ProtocolVersion: ${APP_TARGET_GROUP_PROTOCOL}
  Port: ${LOAD_BALANCER_PORT}
  VpcId: $(sage.ec2.describe_vpcs.Vpcs.0.VpcId)
app.elb.create_load_balancer:
  Name: ${APP_LOAD_BALANCER_NAME}
  Subnets:
    - $(sage.ec2.describe_subnets.Subnets.0.SubnetId)
    - $(sage.ec2.describe_subnets.Subnets.1.SubnetId)
    - $(sage.ec2.describe_subnets.Subnets.2.SubnetId)
    - $(sage.ec2.describe_subnets.Subnets.3.SubnetId)
  SecurityGroups:
    - $(sage.ec2.describe_security_groups.SecurityGroups.0.GroupId)
  Scheme: ${LOAD_BALANCER_SCHEME}
  Type: ${LOAD_BALANCER_TYPE}
app.elb_waiter.wait:
  Names:
    - ${APP_LOAD_BALANCER_NAME}
app.elb.describe_load_balancers:
  Names:
    - ${APP_LOAD_BALANCER_NAME}
app.route53.change_resource_record_sets:
  HostedZoneId: $(sage.route53.list_hosted_zones_by_name.HostedZones.0.Id)
  ChangeBatch:
    Changes:
      - Action: UPSERT
        ResourceRecordSet:
          Name: ${APP_DOMAIN}
          Type: A
          AliasTarget:
            HostedZoneId: $(app.elb.describe_load_balancers.LoadBalancers.0.CanonicalHostedZoneId)
            DNSName: $(app.elb.describe_load_balancers.LoadBalancers.0.DNSName)
            EvaluateTargetHealth: false
app.elb.create_listener:
  LoadBalancerArn: $(app.elb.describe_load_balancers.LoadBalancers.0.LoadBalancerArn)
  Protocol: ${LOAD_BALANCER_PROTOCOL}
  Port: ${LOAD_BALANCER_PORT}
  Certificates:
    - CertificateArn: $(sage.acm.request_certificate.CertificateArn)
  DefaultActions:
    - Type: forward
      TargetGroupArn: $(app.elb.create_target_group.TargetGroups.0.TargetGroupArn)
app.ecs.register_task_definition:
  family: ${APP_TASK_DEFINITION_NAME}
  containerDefinitions:
    - name: ${APP_NAME}
      image: ${DOCKER_REGISTRY}/${APP_NAME}:c1c95e0
      secrets:
        - name: DB_USERNAME
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_USERNAME
        - name: DB_PASSWORD
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_PASSWORD
        - name: DB_NAME
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_NAME
        - name: DB_HOST
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_HOST
        - name: DB_PORT
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_PORT
        - name: APPLE_BUNDLE_ID
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/APPLE_BUNDLE_ID
        - name: APPLE_CLIENT_SECRET
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/APPLE_CLIENT_SECRET
        - name: APP_PORT
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/APP_PORT
      logConfiguration:
        logDriver: awslogs
        options:
          awslogs-group: ${APP_NAME}-logs
          awslogs-region: ${SAGE_REGION}
          awslogs-stream-prefix: ${APP_NAME}
          awslogs-create-group: "true"
      portMappings:
        - containerPort: ${APP_PORT}
          protocol: tcp
          appProtocol: ${APP_PROTOCOL}
  executionRoleArn: $(sage.iam.get_role.Role.Arn)
  taskRoleArn: $(sage.iam.get_role.Role.Arn)
  networkMode: awsvpc
  requiresCompatibilities:
    - FARGATE
  cpu: "${APP_CPU}"
  memory: "${APP_MEMORY}"
app.ecs.create_service:
  serviceName: ${APP_NAME}
  cluster: $(cluster.ecs.create_cluster.cluster.clusterArn)
  taskDefinition: $(app.ecs.register_task_definition.taskDefinition.taskDefinitionArn)
  desiredCount: ${APP_TASK_COUNT}
  loadBalancers:
    - targetGroupArn: $(app.elb.create_target_group.TargetGroups.0.TargetGroupArn)
      containerName: ${APP_NAME}
      containerPort: ${APP_PORT}
  launchType: FARGATE
  networkConfiguration:
    awsvpcConfiguration:
      subnets:
        - $(sage.ec2.describe_subnets.Subnets.0.SubnetId)
        - $(sage.ec2.describe_subnets.Subnets.1.SubnetId)
        - $(sage.ec2.describe_subnets.Subnets.2.SubnetId)
        - $(sage.ec2.describe_subnets.Subnets.3.SubnetId)
      securityGroups:
        - $(sage.ec2.describe_security_groups.SecurityGroups.0.GroupId)
      assignPublicIp: ENABLED
app.ecs.update_service:
  service: ${APP_NAME}
  cluster: $(cluster.ecs.create_cluster.cluster.clusterArn)
  taskDefinition: $(app.ecs.register_task_definition.taskDefinition.taskDefinitionArn)
  forceNewDeployment: true
---
wss.image.build:
  tag: ${DOCKER_REGISTRY}/${WSS_NAME}:$(repo.user.get_latest_repo_revision)
  path: wss
  dockerfile: Dockerfile
wss.image.push:
  repository: ${DOCKER_REGISTRY}/${WSS_NAME}
  tag: $(repo.user.get_latest_repo_revision)
  auth_config:
    username: ${DOCKER_HUB_USERNAME}
    password: ${DOCKER_HUB_PASSWORD}
wss.elb.create_target_group:
  Name: ${WSS_TARGET_GROUP_NAME}
  Protocol: ${LOAD_BALANCER_PROTOCOL}
  ProtocolVersion: ${WSS_TARGET_GROUP_PROTOCOL}
  Port: ${LOAD_BALANCER_PORT}
  TargetType: ${WSS_TARGET_GROUP_TYPE}
  VpcId: $(sage.ec2.describe_vpcs.Vpcs.0.VpcId)
wss.elb.create_load_balancer:
  Name: ${WSS_LOAD_BALANCER_NAME}
  Subnets:
    - $(sage.ec2.describe_subnets.Subnets.0.SubnetId)
    - $(sage.ec2.describe_subnets.Subnets.1.SubnetId)
    - $(sage.ec2.describe_subnets.Subnets.2.SubnetId)
    - $(sage.ec2.describe_subnets.Subnets.3.SubnetId)
  SecurityGroups:
    - $(sage.ec2.describe_security_groups.SecurityGroups.0.GroupId)
  Scheme: ${LOAD_BALANCER_SCHEME}
  Type: ${LOAD_BALANCER_TYPE}
wss.elb_waiter.wait:
  Names:
    - ${WSS_LOAD_BALANCER_NAME}
wss.elb.describe_load_balancers:
  Names:
    - ${WSS_LOAD_BALANCER_NAME}
wss.route53.change_resource_record_sets:
  HostedZoneId: $(sage.route53.list_hosted_zones_by_name.HostedZones.0.Id)
  ChangeBatch:
    Changes:
      - Action: UPSERT
        ResourceRecordSet:
          Name: ${WSS_DOMAIN}
          Type: A
          AliasTarget:
            HostedZoneId: $(wss.elb.describe_load_balancers.LoadBalancers.0.CanonicalHostedZoneId)
            DNSName: $(wss.elb.describe_load_balancers.LoadBalancers.0.DNSName)
            EvaluateTargetHealth: false
wss.elb.create_listener:
  LoadBalancerArn: $(wss.elb.describe_load_balancers.LoadBalancers.0.LoadBalancerArn)
  Protocol: ${LOAD_BALANCER_PROTOCOL}
  Port: ${LOAD_BALANCER_PORT}
  Certificates:
    - CertificateArn: $(sage.acm.request_certificate.CertificateArn)
  DefaultActions:
    - Type: forward
      TargetGroupArn: $(wss.elb.create_target_group.TargetGroups.0.TargetGroupArn)
wss.ecs.register_task_definition:
  family: ${WSS_TASK_DEFINITION_NAME}
  containerDefinitions:
    - name: ${WSS_NAME}
      image: ${DOCKER_REGISTRY}/${WSS_NAME}:c1c95e0
      secrets:
        - name: DB_USERNAME
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_USERNAME
        - name: DB_PASSWORD
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_PASSWORD
        - name: DB_NAME
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_NAME
        - name: DB_HOST
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_HOST
        - name: DB_PORT
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/DB_PORT
        - name: APPLE_BUNDLE_ID
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/APPLE_BUNDLE_ID
        - name: APPLE_CLIENT_SECRET
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/APPLE_CLIENT_SECRET
        - name: WSS_PORT
          valueFrom: arn:aws:ssm:${SAGE_REGION}:${SAGE_ACCOUNT_ID}:parameter/WSS_PORT
      logConfiguration:
        logDriver: awslogs
        options:
          awslogs-group: ${WSS_NAME}-logs
          awslogs-region: ${SAGE_REGION}
          awslogs-stream-prefix: ${WSS_NAME}
          awslogs-create-group: "true"
      portMappings:
        - containerPort: ${WSS_PORT}
          protocol: tcp
          appProtocol: ${WSS_PROTOCOL}
  executionRoleArn: $(sage.iam.get_role.Role.Arn)
  taskRoleArn: $(sage.iam.get_role.Role.Arn)
  networkMode: awsvpc
  requiresCompatibilities:
    - FARGATE
  cpu: "${WSS_CPU}"
  memory: "${WSS_MEMORY}"
wss.ecs.create_service:
  serviceName: ${WSS_NAME}
  cluster: $(cluster.ecs.create_cluster.cluster.clusterArn)
  taskDefinition: $(wss.ecs.register_task_definition.taskDefinition.taskDefinitionArn)
  desiredCount: ${WSS_TASK_COUNT}
  loadBalancers:
    - targetGroupArn: $(wss.elb.create_target_group.TargetGroups.0.TargetGroupArn)
      containerName: ${WSS_NAME}
      containerPort: ${WSS_PORT}
  launchType: FARGATE
  networkConfiguration:
    awsvpcConfiguration:
      subnets:
        - $(sage.ec2.describe_subnets.Subnets.0.SubnetId)
        - $(sage.ec2.describe_subnets.Subnets.1.SubnetId)
        - $(sage.ec2.describe_subnets.Subnets.2.SubnetId)
        - $(sage.ec2.describe_subnets.Subnets.3.SubnetId)
      securityGroups:
        - $(sage.ec2.describe_security_groups.SecurityGroups.0.GroupId)
      assignPublicIp: ENABLED
wss.ecs.update_service:
  service: ${WSS_NAME}
  cluster: $(cluster.ecs.create_cluster.cluster.clusterArn)
  taskDefinition: $(wss.ecs.register_task_definition.taskDefinition.taskDefinitionArn)
  forceNewDeployment: true
---
db.rds.create_db_parameter_group:
  DBParameterGroupName: ${DB_PARAMETER_GROUP_NAME}
  DBParameterGroupFamily: ${DB_PARAMETER_GROUP_FAMILY}
  Description: Sage parameter group
db.rds.modify_db_parameter_group:
  DBParameterGroupName: ${DB_PARAMETER_GROUP_NAME}
  Parameters:
    - ParameterName: rds.force_ssl
      ParameterValue: "0"
      ApplyMethod: immediate
db.rds.describe_db_parameter_groups:
  DBParameterGroupName: ${DB_PARAMETER_GROUP_NAME}
db.ec2.create_security_group:
  GroupName: ${DB_SECURITY_GROUP_NAME}
  Description: Sage db security group
db.ec2.authorize_security_group_ingress:
  GroupName: ${DB_SECURITY_GROUP_NAME}
  IpPermissions:
    - FromPort: ${DB_PORT}
      ToPort: ${DB_PORT}
      IpProtocol: tcp
      IpRanges:
        - CidrIp: "0.0.0.0/0"
db.ec2.describe_security_groups:
  GroupNames:
    - ${DB_SECURITY_GROUP_NAME}
db.rds.create_db_instance:
  AllocatedStorage: 20
  DBInstanceClass: ${DB_INSTANCE_CLASS}
  DBName: ${DB_NAME}
  DBInstanceIdentifier: ${DB_NAME}-instance
  DBParameterGroupName: ${DB_PARAMETER_GROUP_NAME}
  VpcSecurityGroupIds:
    - $(db.ec2.describe_security_groups.SecurityGroups.0.GroupId)
  Engine: ${DB_ENGINE}
  MasterUsername: ${DB_USERNAME}
  MasterUserPassword: ${DB_PASSWORD}
db.rds_waiter.wait:
  DBInstanceIdentifier: ${APP_NAME}-${DB_NAME}
db.route53.change_resource_record_sets:
  HostedZoneId: $(sage.route53.list_hosted_zones_by_name.HostedZones.0.Id)
  ChangeBatch:
    Changes:
      - Action: UPSERT
        ResourceRecordSet:
          Name: ${DB_DOMAIN}
          Type: CNAME
          TTL: 300
          ResourceRecords:
            - Value: $(db.rds.create_db_instance.Endpoint.Address)
